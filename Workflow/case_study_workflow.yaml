main:
  steps:
    - init:
        assign:
          - project: "case-study-azsde"
          - location: "europe-west3"
          - query: "CREATE OR REPLACE TABLE lz_case_study.enriched_bike_trips AS (
                    SELECT 
                    bt.BIKE_ID,
                    bt.DURATION_HOURS,
                    bt.START_STATION_NAME,
                    bt.TRIP_DATE,
                    wd.temp,
                    bd.manufacturer,
                    (bd.price_eur * dd.Rate) AS bike_price
                    FROM `case-study-azsde.lz_case_study.bike_trips` AS bt
                    JOIN `case-study-azsde.lz_case_study.weather_data` AS wd
                    ON bt.TRIP_DATE = DATE(wd.datetime)
                    JOIN `case-study-azsde.lz_case_study.bikes_data` AS bd
                    ON bt.BIKE_ID = CAST(bd.bike_id AS STRING)
                    JOIN `case-study-azsde.lz_case_study.devizova_data` AS dd
                    ON bt.TRIP_DATE = dd.Datum
                    )"
          - blob_storage_name: "blob_storage"
          - devizovy_trh_name: "devizovy_trh"
          - weather_report_name: "weather_report"
          - public_trips_name: "public_trips"
    - getBlobStorageFunction:
        call: googleapis.cloudfunctions.v2.projects.locations.functions.get
        args:
          name: ${"projects/" + project + "/locations/" + location + "/functions/" + blob_storage_name}
        result: blob_storage
    - callBlobStorage:
        call: http.get
        args:
          url: ${blob_storage.url}
    - parallelStep:
        parallel:
          branches:
            - getDevizovyTrh:
                steps:
                  - getDevizovyTrhFunction:
                      call: googleapis.cloudfunctions.v2.projects.locations.functions.get
                      args:
                        name: ${"projects/" + project + "/locations/" + location + "/functions/" + devizovy_trh_name}
                      result: devizovy_trh
                  - callDevizovyTrh:
                      call: http.get
                      args:
                        url: ${devizovy_trh.url}
            - getWeatherReport:
                steps:
                  - getWeatherReportFunction:
                      call: googleapis.cloudfunctions.v2.projects.locations.functions.get
                      args:
                        name: ${"projects/" + project + "/locations/" + location + "/functions/" + weather_report_name}
                      result: weather_report
                  - callWeatherReport:
                      call: http.get
                      args:
                        url: ${weather_report.url}
    - getPublicTripsFunction:
        call: googleapis.cloudfunctions.v2.projects.locations.functions.get
        args:
          name: ${"projects/" + project + "/locations/" + location + "/functions/" + public_trips_name}
        result: public_trips
    - callPublicTrips:
        call: http.get
        args:
          url: ${public_trips.url}
    - insertEnrichedTable:
        call: googleapis.bigquery.v2.jobs.insert
        args:
          projectId: ${project}
          body:
            configuration:
              query:
                query: ${query}
                allowLargeResults: true
                useLegacySql: false